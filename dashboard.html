<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Member Dashboard</title>
  <link rel="stylesheet" href="style.css" />
  <!-- (Removed Firebase SDK includes: logic replaced with backend fetch) -->

  <!-- Toast Notification Styles -->
  <style>
    #toast {
      visibility: hidden;
      min-width: 250px;
      margin-left: -125px;
      background-color: #0056b3;
      color: #FFD700;
      text-align: center;
      border-radius: 8px;
      padding: 16px;
      position: fixed;
      z-index: 9999;
      left: 50%;
      bottom: 40px;
      font-size: 1.1rem;
      box-shadow: 0 4px 16px rgba(0,0,0,0.18);
      transition: visibility 0s, opacity 0.5s linear;
      opacity: 0;
    }
    #toast.show {
      visibility: visible;
      opacity: 1;
    }
    /* Notifications Modal */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      z-index: 10000;
    }
    .modal {
      background: #fff;
      border-radius: 8px;
      padding: 20px;
      position: relative;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 90%;
      max-width: 500px;
      box-shadow: 0 4px 16px rgba(0,0,0,0.2);
    }
    .modal h2 {
      margin-top: 0;
      color: #00274D;
    }
    .confirm-btn {
      background: #0056b3;
      color: #fff;
      border: none;
      padding: 10px 20px;
      border-radius: 4px;
      cursor: pointer;
      font-weight: 600;
    }
    .confirm-btn:hover {
      background: #004494;
    }

    /* required field star */
    .required { color: #e74c3c; margin-left: 6px; font-weight: 700; }

    /* Container */
.container {
  max-width: 1000px; /* Fit most laptop screens */
  width: 90%;
  margin: 0 auto;
  padding: 20px;
  box-sizing: border-box;
}

/* Make form elements full width */
form input[type="text"],
form input[type="email"],
form input[type="date"],
form input[type="number"],
form select {
  width: 100%;
  padding: 8px;
  margin: 6px 0 12px 0;
  border-radius: 4px;
  border: 1px solid #ccc;
  box-sizing: border-box;
}

/* Radio buttons and checkboxes spacing */
input[type="radio"] {
  margin-right: 6px;
  margin-top: 10px;
}

/* Submit button */
form button[type="submit"] {
  padding: 12px 24px;
  font-size: 1rem;
  border-radius: 6px;
  border: none;
  background-color: #0056b3;
  color: #fff;
  cursor: pointer;
}

form button[type="submit"]:hover {
  background-color: #004494;
}

/* Modal */
.modal {
  width: 90%;
  max-width: 600px; /* scale for laptops */
}

/* Responsive for smaller laptops or tablets */
@media screen and (max-width: 1200px) {
  .container {
    width: 95%;
  }
}

@media screen and (max-width: 768px) {
  .logo {
    width: 60px;
    height: 60px;
  }
  h1 {
    font-size: 1.5rem;
  }
}

  </style>
</head>
<body>
  <div class="container">
  <div class="header">
  <div class="title-and-upload">
    <div class="upload-box">
      <!-- previewImage and profileImage kept so visuals remain unchanged -->
      <img id="previewImage" src="images/placeholder.png" alt="Upload Photo" />
      <input type="file" id="profileImage" name="profileImage" accept="image/*" />
    </div>
    <h2 class="title">
      Sangguniang Kabataan<br>
      <span class="subtitle">Profiling System</span>
    </h2>
  </div>
  <img src="sk.jpg" alt="SK Logo" class="logo" />
</div>

<button id="logoutBtn" onclick="logoutMember()">Logout</button>

    <h2>Member Profiling Form</h2>
    <form id="skForm">
      <!-- Personal Information -->
      <fieldset>
        <legend>Basic Personal Information</legend>
        <label>Name: <span class="required" aria-hidden="true">*</span></label>
        <input type="text" name="name" required />

        <label>Email: <span class="required" aria-hidden="true">*</span></label>
        <input type="email" name="email" required />

        <label>Date of Birth: <span class="required" aria-hidden="true">*</span></label>
        <input type="date" name="dob" required />

        <label>Age: <span class="required" aria-hidden="true">*</span></label>
        <input type="number" name="age" min="0" max="120" required />

        <label>Gender:</label><br />
        <input type="radio" name="gender" value="Male" /> Male
        <input type="radio" name="gender" value="Female" /> Female
        <input type="radio" name="gender" value="Other" /> Other<br />

        <label>Civil Status:</label>
        <select name="civil_status">
          <option>Single</option>
          <option>Married</option>
          <option>Widowed</option>
          <option>Separated</option>
        </select>

        <label>Religion:</label>
        <input type="text" name="religion" />

        <label>Contact Number:</label>
        <input type="text" name="contact" />

        <label>Address:</label>
        <input type="text" name="address" />
      </fieldset>

      <!-- Education -->
      <fieldset>
        <legend>Education</legend>
        <label>Highest Level of Education:</label>
        <select name="school_level">
          <option>Elementary</option>
          <option>Secondary</option>
          <option>Tertiary</option>
          <option>Vocational</option>
          <option>Not Applicable</option>
        </select>

        <label>School Name / Institution:</label>
        <input type="text" name="school_name" />

        <label>School Status (enrolled/graduate):</label>
        <input type="text" name="school_status" />
      </fieldset>

      <!-- Employment -->
      <fieldset>
        <legend>Employment</legend>
        <label>Employment Status (employed/unemployed):</label>
        <input type="text" name="employment" />

        <label>Type of Work (if any):</label>
        <input type="text" name="work_type" />

        <label>Working hours (if employed):</label>
        <input type="text" name="work_time" />
      </fieldset>

      <!-- Health -->
      <fieldset>
        <legend>Health</legend>
        <label>Known illnesses or conditions:</label>
        <input type="text" name="illnesses" />

        <label>Access to health care:</label>
        <input type="text" name="healthcare" />

        <label>Disabilities or special needs:</label>
        <input type="text" name="disabilities" />
      </fieldset>

      <!-- Safety -->
      <fieldset>
        <legend>Safety & Security</legend>
        <label>Involvement in Youth Organizations:</label>
        <input type="text" name="youth_org" />

        <label>Exposure to Risks (e.g. drugs, abuse, bullying):</label>
        <input type="text" name="risks" />

        <label>Experience with Violence, Accidents, or Disasters:</label>
        <input type="text" name="experience" />
      </fieldset>

      <!-- Engagement -->
      <fieldset>
        <legend>Youth Engagement & Interests</legend>
        <label>Member of any youth groups or sports teams:</label>
        <input type="text" name="groups" />

        <label>Willingness to Participate in SK Programs:</label><br />
        <input type="radio" name="willingness" value="Yes" /> Yes<br />
        <input type="radio" name="willingness" value="No" /> No<br />
      </fieldset>

      <!-- Emergency Contact -->
      <fieldset>
        <legend>Emergency Contact</legend>
        <label>Name of Guardian/Parent:</label>
        <input type="text" name="guardian_name" />

        <label>Contact Number:</label>
        <input type="text" name="guardian_contact" />

        <label>Relationship to Youth:</label>
        <input type="text" name="relationship" />
      </fieldset>

      <button type="submit">Submit</button>
    </form>
    <div style="margin-top:12px;">
      <button id="exportPdfBtn" type="button" onclick="exportFormPdf()" style="padding:10px 16px;background:#0056b3;color:#fff;border:none;border-radius:6px;cursor:pointer;">
        Export Profile to PDF
      </button>
    </div>
  </div>
  <div id="toast"></div>

  <!-- html2pdf library (client-side) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.2/html2pdf.bundle.min.js"></script>

  <!-- ========== START: REPLACED LOGIC (Node/Express + PostgreSQL backend) ========== -->
  <script>
    /*
      Dashboard logic (replaces Firebase).
      - Uses the backend API at http://localhost:4000/api
      - Expects localStorage keys set by index.html:
          sk_token  (JWT token)
          sk_user_id (user UUID)
      - GET  /api/members/profile
      - POST /api/members/profile  (multipart/form-data, file field: profileImage)
      - GET  /api/members/profile/image/:userId
    */

    const API_BASE = 'http://localhost:4000/api';
    const token = localStorage.getItem('sk_token');
    const userId = localStorage.getItem('sk_user_id');

    // If not logged in, preserve previous behavior -> redirect to index
    if (!token || !userId) {
      window.location.href = 'index.html';
    }

    // Simple toast
    function showToast(msg) {
      const el = document.getElementById('toast');
      el.textContent = msg;
      el.classList.add('show');
      setTimeout(()=> el.classList.remove('show'), 3000);
    }

    // Load profile and populate fields
    async function loadProfileAndPopulate() {
      try {
        const res = await fetch(`${API_BASE}/members/profile`, {
          method: 'GET',
          headers: { 'Authorization': 'Bearer ' + token }
        });
        if (res.status === 401) {
          // token invalid => redirect to login
          localStorage.removeItem('sk_token');
          localStorage.removeItem('sk_user_id');
          return window.location.href = 'index.html';
        }
        const json = await res.json();
        const profile = json.profile;
        if (!profile) return;

        // Map profile values into form fields by name
        Object.keys(profile).forEach(key => {
          if (['profile_image','image_mime','id','user_id','updated_at'].includes(key)) return;
          const value = profile[key];
          if (value === null || value === undefined) return;
          const els = document.getElementsByName(key);
          if (!els || els.length === 0) return;

          // radio handling
          if (els[0].type === 'radio') {
            for (const r of els) { if (r.value === String(value)) { r.checked = true; break; } }
          } else if (els[0].tagName === 'SELECT' || els[0].tagName === 'INPUT' || els[0].tagName === 'TEXTAREA') {
            try { els[0].value = value; } catch(e){}
          } else {
            try { els[0].value = value; } catch(e){}
          }
        });

        // Show profile image if available
        const imgEl = document.getElementById('previewImage');
        if (imgEl) {
          // try fetching image (will 404 if none)
          imgEl.src = `${API_BASE}/members/profile/image/${userId}?t=${Date.now()}`;
          imgEl.style.display = 'block';
        }
      } catch (err) {
        console.error('Error loading profile:', err);
      }
    }

    // Wire form submit to send multipart/form-data to backend
    function wireProfileFormSubmit() {
  const form = document.getElementById('skForm');
  if (!form) { console.warn('Form not found'); return; }

  form.addEventListener('submit', async (e) => {
    e.preventDefault();

    // Build FormData from the form fields
    const fd = new FormData(form);

    // Ensure file is appended even if input is outside the form or not picked up earlier
    const fileInput = document.querySelector('input[type="file"][name="profileImage"]') || document.getElementById('profileImage');
    if (fileInput && fileInput.files && fileInput.files[0]) {
      fd.set('profileImage', fileInput.files[0]); // set() replaces or adds
    }

    try {
      const res = await fetch(`${API_BASE}/members/profile`, {
        method: 'POST',
        headers: { 'Authorization': 'Bearer ' + token }, // DO NOT set Content-Type manually
        body: fd
      });
      const data = await res.json();
      if (!res.ok) {
        const err = (data && data.error) ? data.error : 'Failed to save profile';
        showToast(err);
        return;
      }
      showToast('Profile saved successfully.');
      // refresh preview from server if uploaded
      const imgEl = document.getElementById('previewImage');
      if (imgEl) imgEl.src = `${API_BASE}/members/profile/image/${userId}?t=${Date.now()}`;
    } catch (err) {
      console.error('Save profile error:', err);
      showToast('Error saving profile.');
    }
  });
}

    // Wire local image preview when file input changes
    function wireImagePreview() {
      const fileInput = document.querySelector('input[type="file"][name="profileImage"]') || document.getElementById('profileImage');
      const imgEl = document.getElementById('previewImage');
      if (!fileInput || !imgEl) return;

      fileInput.addEventListener('change', (ev) => {
        const f = ev.target.files && ev.target.files[0];
        if (!f) return;
        const reader = new FileReader();
        reader.onload = function(e) {
          imgEl.src = e.target.result;
          imgEl.style.display = 'block';
        };
        reader.readAsDataURL(f);
      });
    }

    // Logout handler (keeps the original name used in HTML)
    function logoutMember() {
      localStorage.removeItem('sk_token');
      localStorage.removeItem('sk_user_id');
      window.location.href = 'index.html';
    }

    // PDF export (keeps original export behavior)
    function exportFormPdf() {
      const form = document.getElementById('skForm');
      if (!form) return alert('Form not found.');

      const data = {};
      Array.from(form.elements).forEach(el => {
        if (!el.name) return;
        if (el.type === 'radio') {
          if (el.checked) data[el.name] = el.value;
        } else {
          data[el.name] = el.value || '';
        }
      });

      // Build a simple printable container
      const container = document.createElement('div');
      container.style.padding = '18px';
      container.style.fontFamily = 'Arial, sans-serif';
      container.style.color = '#00274D';
      container.style.background = '#fff';

      const heading = document.createElement('h2');
      heading.innerText = 'Member Profile';
      heading.style.textAlign = 'center';
      container.appendChild(heading);

      const table = document.createElement('table');
      table.style.width = '100%';
      table.style.borderCollapse = 'collapse';
      Object.keys(data).forEach(k => {
        const tr = document.createElement('tr');
        const td1 = document.createElement('td');
        td1.style.width = '35%';
        td1.style.fontWeight = '700';
        td1.style.padding = '6px';
        td1.innerText = k;
        const td2 = document.createElement('td');
        td2.style.padding = '6px';
        td2.innerText = data[k];
        tr.appendChild(td1);
        tr.appendChild(td2);
        table.appendChild(tr);
      });
      container.appendChild(table);

      const opt = {
        margin: 10,
        filename: `profile_export.pdf`,
        image: { type: 'jpeg', quality: 0.98 },
        html2canvas: { scale: 2, useCORS: true },
        jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
      };

      html2pdf().set(opt).from(container).save().catch(err => {
        console.error('PDF export failed', err);
        alert('Failed to export PDF.');
      });
    }

    // Init wiring
    document.addEventListener('DOMContentLoaded', () => {
      loadProfileAndPopulate();
      wireProfileFormSubmit();
      wireImagePreview();

      // keep logoutBtn behavior in case onclick not wired
      const lb = document.getElementById('logoutBtn');
      if (lb) lb.addEventListener('click', logoutMember);
    });
  </script>
  <!-- ========== END: REPLACED LOGIC ========== -->

</body>
</html>
